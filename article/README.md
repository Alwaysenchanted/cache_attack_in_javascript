# 沙箱中的间谍 - 一种可行的JavaScript缓存攻击
------------------------

## 术语表
- Cache Memory 高速缓存
- last-level cache
- Cache set 缓存块
- Cache line 缓存线
- cache miss 缓存未命中
- eviction 移除
- privilege ring 特权环
- page frame 页框
- side channel 旁路（边信道）
- eviction set 移除集

## 翻译参考
- http://baike.baidu.com/link?url=jQGLb4ZNHV9ReIvGyRJppN94pp-ztWK-qcN0vsNzJTeKy3Htl6YpDgguwRtP2OGHpwKoX0U0vpTvqD-tuYXWa_
- http://www.docin.com/p-692268752.html

------------------------

## 摘要

本文将展示一种完全运行在浏览器里的针对微架构的旁路攻击方式。与这个领域里的其它攻击方式不同，这种方法不需要攻击者在受害者的电脑上安装任何
应用程序来展开攻击，受害者只需要打开一个被攻击者控制的不可信的网页。这种攻击模型可伸缩性很高，十分贴近现在的网络环境，绝大多数连接到Internet
的桌面浏览器都无法防御。这种攻击手段是Yarom等人【23】提出的last-level attak攻击的扩展，可以让身处远方的对手获得属于其它进程，其他用户甚至是
同一台宿主上的虚拟机的信息，只要它们和受害者的浏览器运行在一起。我们描述了这种攻击背后的基本原理，用一种高带宽的隐藏通道验证了它的性能，最后
用它构建了一种系统级别的鼠标和网络的活动记录器。抵御这种攻击使可能的，但是所需的反制措施将会对浏览器和电脑的正常使用产生不切实际的代价。


## 1 简介

边信号分析是密码学攻击里一种非常强大的类别。攻击者通过分析安全设备内部在进行安全运算时所产生的的物理信号（电流，辐射，热量等）来取得秘密信息。
据说在二战中便有情报部门在使用，并由Kocher等人在1996年[14]首次在学术环境下讨论。边信号分析被证实可以侵入无数的现实世界中的系统，从汽车报警器
到高安全性的密码协处理器[8][18]。缓存攻击是和个人电脑相关的一种边信号攻击，因为缓存区被不同的进程或者用户使用导致秘密信息的泄露[17][11]。

虽然旁路攻击的能效不容置疑，但是真正应用到实际的系统上是相对受限的。影响旁路攻击的一个主要问题因素是对**攻击模型**的假设：除了基于网络的
时序攻击，大部分的旁路攻击都要求攻击者非常接近受害者。对缓存攻击而言，一般会假设能够在受害者的机器上执行任意的二进制的代码。虽然这个假设
适用于像 Amazon 云计算平台这样的 IaaS 或者 PaaS 环境，但是对于其它设置而言就不是那么相关了。

在这篇报告里，我们用一种约束更少、更可行的攻击者模型挑战了这一限制性的安全假设。在这个模型里，受害者只需要**访问一个网页**，这个网页
由攻击者所拥有。我们会展示即使在这么简单的攻击者模型里，攻击者依然能够在可行的时间长度里，从被攻击的系统中提取出有意义的信息。为了和这样的
计算设定保持一致，我们把注意力集中在了**跟踪用户行为**而不是获取密匙上。报告中的攻击方式因为这些原因是高度可行的：对于攻击者的假设和限定是
实际的；运行的时间是实际的；对攻击者带来的好处也是实际的。据我们掌握的知识，这是首个可以轻松扩展至上百万个目标的旁路攻击方式。

我们假设攻击中受害者使用的个人电脑配备有比较新的 Intel CPU 信号，并进一步假设用户用支持 HTML5 的浏览器访问网页。见章节 5.1 ，这覆盖了
绝大部分连接到 Internet 的个人电脑。用户被强迫访问页面，这个页面上有一个由攻击者控制的元素比如广告。攻击代码会自动执行基于JavaScript的
缓存攻击（详见章节2），可以持续地访问被攻击系统的 last-level cache (LLC) 。因为所有的CPU内核，用户，进程，保护令牌等共享同一个缓存，所以
可以为攻击者提供用户和被攻击系统的详细信息。
 
### 1.1 现代 Intel CPU 的内存架构
 
现代的计算机系统通常会采用一个高速的中央处理器和一个容量大但是速度较慢的随机存取器。为了桥接这两个模块的性能差异，现代的计算机系统会采用
高速缓存 - 一种容量容量小的多但是速度更快的内存元素，着里面保存了 RAM 中最近被 CPU 访问过的子集。高速缓存通常会采用分层设计，在 CPU 和 RAM 
之间分层放置一些列更大和更慢的缓存元素。图1取自[22]，展示了 Intel Ivy Bridge 的缓存结构，包括，较小的 level 1(L1) cache，大一些的
level 2 (L2) cache，最后是最大的 level 3 (L3) cache 并和 RAM 相连。Intel 当前代号为 Haswell 的新一代 CPU 采用了另一种嵌入式的 
DRAM(eDRAM) 设计，不在讨论范围内。如果 CPU 需要访问的数据当前不在缓存里，会触发一个 **cache miss** ，为了给新元素腾出空间，当前缓存
里的一项必须被 **evicted**。
  
Intel 的缓存微架构是**嵌套的**-所有一级缓存里的数据必须同时存在二级和三级缓存里。反过来的，如果某个元素在三级缓存里被移除，那它也会立刻被
从二级和一级缓存里移走。需要注意的是 AMD 缓存微架构的设计是专一的，所以本文描述的方法并不能立刻应用到该平台上。
  
本文重点关注的是三级缓存，通常也被称为 last-level cache (LLC)。由于 LLC 较大，CPU 访问内存的时候如果把整个LLC的内容都搜索一遍效率会很低。
为了避免这个问题，LLC 通常被分成不同的**缓存块**，每一块都对应者内存空间的一个固定的子集。每个缓存块包含若干缓存线。比如 Haswell 系列中的 
Intel Core i7-3720QM 处理器拥有 8192 = 2^13 个缓存块，每个块有 12 条 64 = 2^6 字节的缓存线，共同组成 8192x12x64 = 6 MB的高速缓存。
CPU 如果要检查一个给定的物理地址是否在三级缓存里，会首先计算出缓存块，然后只检查块内的缓存线。结果就是，某个物理地址的缓存未命中，会导致共享
同一个缓存块的少量缓存线中的一条被移除，这个事实会被我们的攻击大量运用。由64比特的物理地址到13比特的缓存块索引的映射方法已经被 Hund 等人在
2013年逆向工程出来。在表示物理地址的64个bit里，5到0被忽略，16到6被直接用来作为快索引的低11位，63到17被散列来生成块索引的高两位。LLC 被
不同的内核、线程、进程、用户，乃至运行在一块 CPU 芯片上的虚拟机所共享，而不论特权环或其它类似的保护措施。

现代的个人电脑用一种虚拟内存机制，在这种机制里用户的进程一般没办法直接知道和访问系统的物理内存。取而代之的是，进程会被分配不同的虚拟内存页。
如果某页被当前执行的进程访问，操作系统会在物理内存里动态地分配一个页框。CPU的内存管理单元(MMU)负责把不同进程对虚拟内存地址的访问映射到实际的
物理内存。Intel 处理器的页和页框大小一般是4KB，页和页框的是按照页对齐的-每页的开始地址是页大小的倍数。这意味着，任何虚拟地址的低12位和对应
的虚拟地址是一一对应的，这一事实也在我们的攻击中用到。

### 1.2 缓存攻击

缓存攻击是针对微架构的攻击手段中一个典型的代表， Aciiamez 在他的出色的调查中定义为 “利用信任架构边际下方的处理器底层结构”从不同的安全系统中
获取秘密信息。 缓存攻击基于这样的事实：尽管在上层有像沙箱、虚拟内存、特权环，宿主这样的安全机制，安全和不安全的进程公用缓存。这使得“间谍”进程
通过公用的缓存来测量和干扰其它安全进程的内部状态。Hu 在1992年的首次发现及随后的一些结果显示了旁路攻击可被用来活取 AES / RSA 的密匙，甚至可以
允许虚拟机侵入宿主上的其它机器。

我们的攻击模型建立在 装填+探测 的基础上，这个方法由 Osvik 在[17]中首次描述，不过那时是针对一级缓存的。之后由 Yarom 等人在[23]中扩展到启用了
较大内存页系统的 last-level cache。我们把这种方法扩展了一下，支持更加常见的4K的页大小。总的来说，缓存攻击有四个步骤。第一步，攻击者建立一个
或多个**移除集**。移除集是内存中的一系列地址，地址被访问的时候会接管受害者进程使用的一条缓存线。第二部，攻击者通过访问移除集填充整个缓存块。
这会使得受害者的代码或指令
